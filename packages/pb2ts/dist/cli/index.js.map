{"version":3,"sources":["../../node_modules/tsup/assets/esm_shims.js","../../src/cli/index.ts","../../src/config/loadConfig.ts","../../src/config/defaults.ts","../../src/config/validate.ts","../../package.json","../../src/parser/runParser.ts","../../src/generator/service.ts","../../src/generator/index.ts","../../src/generator/context.ts"],"sourcesContent":["// Shim globals in esm bundle\nimport path from 'node:path'\nimport { fileURLToPath } from 'node:url'\n\nconst getFilename = () => fileURLToPath(import.meta.url)\nconst getDirname = () => path.dirname(getFilename())\n\nexport const __dirname = /* @__PURE__ */ getDirname()\nexport const __filename = /* @__PURE__ */ getFilename()\n","import cac from 'cac'\nimport pc from 'picocolors'\nimport { loadConfig } from '../config/loadConfig'\nimport { version } from '../../package.json'\nimport { generate } from '../generator'\n\nconst cli = cac('pb2ts')\n\ncli\n    .command(\n        'gen',\n        'Generate TypeScript clients from proto files',\n    )\n    .option('--proto <dir>', 'Proto root directory')\n    .option('--out <dir>', 'Output directory')\n    .option('-c, --config <file>', 'Use specific config file')\n    .action(async (options) => {\n        try {\n            console.log(pc.cyan(`\\n  pb2ts v${version}\\n`))\n\n            const overrides = {\n                proto: options.proto ? { root: options.proto } : undefined,\n                output: options.out ? { dir: options.out } : undefined,\n            }\n\n            const config = loadConfig(process.cwd(), {\n                configFile: options.config,\n                overrides,\n            })\n\n            console.log(pc.green('  Config loaded!'))\n            console.log(pc.dim('  Parsing proto files...'))\n\n            await generate(config)\n\n            console.log(pc.green('\\n  Done!\\n'))\n        } catch (error) {\n            console.error(\n                pc.red(\n                    `\\n  ${error instanceof Error ? error.message : String(error)}\\n`,\n                ),\n            )\n            process.exit(1)\n        }\n    })\n\ncli.help()\ncli.version(version)\n\ncli.parse()\n","import fs from 'fs'\r\nimport path from 'path'\r\nimport jiti from 'jiti'\r\n\r\nimport type { Pb2tsConfig } from './types'\r\nimport { defaultConfig } from './defaults'\r\nimport { validateConfig } from './validate'\r\n\r\nexport interface LoadConfigOptions {\r\n    /**\r\n     * CLI 参数覆盖\r\n     * 优先级最高\r\n     */\r\n    overrides?: Partial<Pb2tsConfig>\r\n\r\n    /**\r\n     * 指定 config 文件路径\r\n     * 默认自动查找\r\n     */\r\n    configFile?: string\r\n}\r\n\r\nconst CONFIG_FILES = [\r\n    'pb2ts.config.ts',\r\n]\r\n\r\nexport function loadConfig(\r\n    cwd: string = process.cwd(),\r\n    options: LoadConfigOptions = {},\r\n): Pb2tsConfig {\r\n    const configPath = options.configFile\r\n        ? path.resolve(cwd, options.configFile)\r\n        : findConfigFile(cwd)\r\n\r\n    let userConfig: Partial<Pb2tsConfig> = {}\r\n\r\n    if (configPath) {\r\n        const load = jiti(__filename, {\r\n            interopDefault: true,\r\n            esmResolve: true,\r\n        })\r\n\r\n        try {\r\n            userConfig = load(configPath)\r\n        } catch (err) {\r\n            throw new Error(\r\n                `Failed to load config file: ${configPath}\\n` +\r\n                (err instanceof Error ? err.message : String(err)),\r\n            )\r\n        }\r\n    }\r\n\r\n    // 合并顺序：default -> user -> cli overrides\r\n    const merged = mergeConfig(\r\n        defaultConfig,\r\n        userConfig,\r\n        options.overrides,\r\n    )\r\n\r\n    validateConfig(merged)\r\n\r\n    return freezeConfig(merged)\r\n}\r\n\r\n/**\r\n * 在 cwd 中查找 config 文件\r\n */\r\nfunction findConfigFile(cwd: string): string | undefined {\r\n    for (const name of CONFIG_FILES) {\r\n        const file = path.join(cwd, name)\r\n        if (fs.existsSync(file)) {\r\n            return file\r\n        }\r\n    }\r\n    return undefined\r\n}\r\n\r\n/**\r\n * 明确的、可控的 merge 逻辑\r\n * - object: shallow merge\r\n * - array: override\r\n * - primitive: override\r\n */\r\nfunction mergeConfig(\r\n    base: Pb2tsConfig,\r\n    user?: Partial<Pb2tsConfig>,\r\n    overrides?: Partial<Pb2tsConfig>,\r\n): Pb2tsConfig {\r\n    const merged: Pb2tsConfig = {\r\n        ...base,\r\n        ...user,\r\n        proto: {\r\n            ...base.proto,\r\n            ...user?.proto,\r\n        },\r\n        output: {\r\n            ...base.output,\r\n            ...user?.output,\r\n        },\r\n    }\r\n\r\n    if (overrides) {\r\n        if (overrides.proto) {\r\n            merged.proto = { ...merged.proto, ...overrides.proto }\r\n        }\r\n        if (overrides.output) {\r\n            merged.output = { ...merged.output, ...overrides.output }\r\n        }\r\n    }\r\n\r\n    return merged\r\n}\r\n\r\n/**\r\n * 防止后续阶段（generator / plugin）意外修改 config\r\n */\r\nfunction freezeConfig<T>(config: T): T {\r\n    Object.freeze(config)\r\n\r\n    for (const value of Object.values(config as Record<string, unknown>)) {\r\n        if (value && typeof value === 'object') {\r\n            Object.freeze(value)\r\n        }\r\n    }\r\n\r\n    return config\r\n}\r\n","import type { Pb2tsConfig } from './types'\nimport type { RPC } from '../parser/types'\n\nexport const defaultConfig: Pb2tsConfig = {\n    proto: {\n        root: './',\n        include: [],\n        exclude: ['node_modules', 'dist'],\n    },\n    output: {\n        dir: 'src/api',\n        imports: ['import { fetch } from \"fetch\"'],\n        defaultFuncTemplate : defaultFuncTemplate,\n    },\n}\n\nfunction defaultFuncTemplate(r:RPC) {\n    if (r.leadingComments == \"\") {\n        r.leadingComments = r.name\n    }\n    return `\n    // ${ r.leadingComments } ${r.name}\n    `\n}","import type { Pb2tsConfig } from './types'\n\nexport function validateConfig(config: Pb2tsConfig): void {\n    if (!config.proto?.root) {\n        throw new Error('config.proto.root is required')\n    }\n\n    if (!config.output?.dir) {\n        throw new Error('config.output.dir is required')\n    }\n}\n","{\n  \"name\": \"pb2ts\",\n  \"version\": \"0.1.0\",\n  \"description\": \"Generate TypeScript HTTP clients from protobuf with google.api.http\",\n  \"author\": \"your-name\",\n  \"license\": \"MIT\",\n  \"type\": \"module\",\n  \"bin\": {\n    \"pb2ts\": \"./dist/cli.js\"\n  },\n  \"exports\": {\n    \".\": {\n      \"types\": \"./dist/index.d.ts\",\n      \"import\": \"./dist/index.js\"\n    }\n  },\n  \"files\": [\n    \"dist\",\n    \"bin\"\n  ],\n  \"scripts\": {\n    \"build\": \"tsup\",\n    \"dev\": \"tsup --watch\",\n    \"typecheck\": \"tsc -p tsconfig.json --noEmit\",\n    \"prepublishOnly\": \"npm run build\"\n  },\n  \"dependencies\": {\n    \"cac\": \"^6.7.14\",\n    \"fs-extra\": \"^11.2.0\",\n    \"jiti\": \"^1.21.0\",\n    \"picocolors\": \"^1.0.0\"\n  },\n  \"devDependencies\": {\n    \"@types/fs-extra\": \"^11.0.4\",\n    \"@types/node\": \"^20.11.5\",\n    \"tsup\": \"^8.0.1\",\n    \"typescript\": \"^5.3.3\"\n  },\n  \"engines\": {\n    \"node\": \">=18\"\n  }\n}\n","import { spawn } from 'child_process'\nimport path from 'path'\nimport fs from 'fs'\nimport type { ParseResult } from './types'\n\nexport async function runParser(protoPath: string, includePaths: string[] = []): Promise<ParseResult> {\n    const packageRoot = path.resolve(__dirname, '..', '..')\n\n    const possiblePaths = [\n        path.resolve(packageRoot, 'bin/pb2ts-parser.exe'),\n        path.resolve(packageRoot, 'bin/pb2ts-parser'),\n        path.resolve(packageRoot, '../../bin/pb2ts-parser.exe'),\n        path.resolve(packageRoot, '../../bin/pb2ts-parser'),\n        path.resolve(process.cwd(), 'bin/pb2ts-parser.exe'),\n        path.resolve(process.cwd(), 'bin/pb2ts-parser'),\n        'pb2ts-parser',\n    ]\n\n    let binPath = ''\n    for (const p of possiblePaths) {\n        if (p === 'pb2ts-parser') {\n            binPath = p\n            break\n        }\n        if (fs.existsSync(p)) {\n            binPath = p\n            break\n        }\n    }\n\n    if (!binPath) {\n        throw new Error('Could not find pb2ts-parser binary')\n    }\n\n    const args = ['--proto', protoPath]\n    if (includePaths.length > 0) {\n        args.push('--imports', includePaths.join(','))\n    }\n\n    return new Promise((resolve, reject) => {\n        const child = spawn(binPath, args)\n\n        let stdout = ''\n        let stderr = ''\n\n        child.stdout.on('data', (data) => {\n            stdout += data.toString()\n        })\n\n        child.stderr.on('data', (data) => {\n            stderr += data.toString()\n        })\n\n        child.on('close', (code) => {\n            if (code !== 0) {\n                reject(new Error(`Parser exited with code ${code}: ${stderr}`))\n                return\n            }\n\n            try {\n                const result = JSON.parse(stdout) as ParseResult\n                resolve(result)\n            } catch (err) {\n                reject(new Error(`Failed to parse JSON output: ${err}\\nOutput: ${stdout}`))\n            }\n        })\n\n        child.on('error', (err) => {\n            reject(err)\n        })\n    })\n}\n","import type { Service } from '../parser/types'\nimport { CodeBuilder } from './context'\nimport type { Pb2tsConfig } from '../config/types'\n\nexport function generateService(service: Service, builder: CodeBuilder, config: Pb2tsConfig) {\n\n}\n","import { runParser } from '../parser/runParser'\nimport type { Pb2tsConfig } from '../config/types'\nimport { generateService } from './service'\nimport path from 'path'\nimport { CodeBuilder } from './context'\n\nexport async function generate(config: Pb2tsConfig) {\n    const protoRoot = path.resolve(process.cwd(), config.proto.root)\n    \n    // 1. Parse\n    // config.proto.include could be passed as imports if they are directories\n    // But currently include is glob patterns.\n    // We'll just pass root to parser.\n    const services = await runParser(protoRoot)\n\n    const builder = new CodeBuilder()\n    \n    // 2. Generate\n    for (const service of services) {\n        generateService(service, builder, config)\n    }\n\n    // 3. Emit\n    const outFile = path.join(config.output.dir, 'index.ts')\n    await emitFile(outFile, builder.toString())\n}\n\n\nasync function emitFile (filePath: string, content: string) {\n    console.log(filePath,content)\n}","import type { Pb2tsConfig } from '../config/types'\nimport type { Service } from '../parser/types'\n\nexport interface GeneratorContext {\n    config: Pb2tsConfig\n    services: Service[]\n}\n\nexport class CodeBuilder {\n    private lines: string[] = []\n    private indentLevel = 0\n\n    indent() {\n        this.indentLevel++\n    }\n\n    unindent() {\n        this.indentLevel = Math.max(0, this.indentLevel - 1)\n    }\n\n    push(line: string = '') {\n        if (line === '') {\n            this.lines.push('')\n            return\n        }\n        const spaces = '    '.repeat(this.indentLevel)\n        this.lines.push(spaces + line)\n    }\n\n    block(start: string, callback: () => void, end: string = '}') {\n        this.push(start)\n        this.indent()\n        callback()\n        this.unindent()\n        this.push(end)\n    }\n\n    toString() {\n        return this.lines.join('\\n')\n    }\n}\n"],"mappings":"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","names":["path","path","path","fs","path","path"]}